<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Care Plan Pre-Assessment (Complete)</title>
  <style>
    /* ---------- Basic Page & Body Styles ---------- */
    body {
      margin: 0 auto;
      max-width: 800px;
      padding: 10px;
      font-family: Arial, sans-serif;
      color: #333;
      font-size: 18px;

      /* Light background plus the ribbon image in the bottom-left corner */
      background-color: #f7f9f4; 
      background-image: url("https://i.ibb.co/tpQ4Yh49/Greensleeves-Care-Brand-Ribbon-scaled.webp");
      background-repeat: no-repeat;
      background-position: bottom left;
      background-size: 300px auto;
    }

    /* ---------- Header & Logo ---------- */
    .header-brand {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      border-bottom: 2px solid #8b9a73;
      padding-bottom: 1rem;
    }
    .header-brand img {
      width: 90px;
      height: auto;
      margin-right: 1rem;
    }
    .header-brand h1 {
      font-size: 1.8rem;
      color: #546038;
      margin: 0;
    }

    /* ---------- Multi-Step Form Steps ---------- */
    .form-step {
      display: none;  /* hidden by default */
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin: 1rem 0;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-step.active {
      display: block; 
    }
    .form-step h2 {
      font-size: 1.4rem;
      margin-top: 0;
    }

    /* ---------- Labels & Inputs ---------- */
    label {
      display: block;
      margin: 1rem 0 0.25rem;
      font-weight: bold;
      font-size: 1rem;
    }
    small {
      display: block;
      font-weight: normal;
      color: #555;
      margin-top: 0.1rem;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 0.8rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      margin-right: 0.5rem;
      transform: scale(1.2);
    }
    /* read-only fields for Age & BMI so users can't overwrite them */
    #age,
    #bmiScore {
      background-color: #f2f2f2;
    }

    /* ---------- Buttons ---------- */
    .btn-container {
      text-align: center;
      margin: 1rem 0;
    }
    .btn-nav {
      cursor: pointer;
      padding: 0.7rem 1.4rem;
      margin: 0.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      background-color: #8b9a73; 
      color: #fff;
    }
    .btn-nav:hover {
      background-color: #6f7f58;
    }

    /* ---------- Summary Textarea ---------- */
    #summary {
      width: 100%;
      min-height: 150px;
      margin-top: 1rem;
      font-size: 1rem;
    }

    /* ---------- Responsive for Mobile (<600px) ---------- */
    @media (max-width: 600px) {
      body {
        padding: 8px;
        font-size: 16px;
      }
      .header-brand {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-brand img {
        margin-bottom: 1rem;
      }
      .header-brand h1 {
        font-size: 1.6rem; 
      }
      .form-step h2 {
        font-size: 1.3rem;
      }
      button {
        width: 100%;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>

  <!-- ========== Greensleeves Logo & Title ========== -->
  <div class="header-brand">
    <img 
      src="https://i.ibb.co/HL44C8Tw/greensleeves-thumbnail-logo-png-120x120-q50-ALIAS-brand-icon-crop-progressive-subsampling-2-upscale.jpg" 
      alt="Greensleeves Care Logo"
    />
    <h1>Care Plan Pre-Assessment</h1>
  </div>

  <form id="assessmentForm">
    <!-- ================= STEP 1: GENERAL INFORMATION ================= -->
    <div class="form-step active" id="step-1">
      <h2>Step 1: General Information</h2>
      <label for="title">Title</label>
      <small>e.g., Mr, Mrs, Ms, Dr</small>
      <input type="text" id="title" name="title" placeholder="Mr/Mrs/Ms/Dr">

      <label for="firstName">First Name</label>
      <small>Use the resident’s official or commonly used name (e.g., John). If they have a preference, note it below.</small>
      <input type="text" id="firstName" name="firstName" placeholder="e.g., John">

      <label for="lastName">Last Name</label>
      <input type="text" id="lastName" name="lastName" placeholder="e.g., Smith">

      <label for="preferredName">Preferred Name</label>
      <small>e.g., “Johnny” or “Liz.” Use correct pronouns (he/him, she/her, they/them).</small>
      <input type="text" id="preferredName" name="preferredName" placeholder="Johnny">

      <label for="sexAtBirth">Sex at Birth</label>
      <input type="text" id="sexAtBirth" name="sexAtBirth" placeholder="Male/Female">

      <label for="genderIdentity">Gender Identity</label>
      <input type="text" id="genderIdentity" name="genderIdentity" placeholder="Man/Woman/etc.">

      <label for="dob">Date of Birth</label>
      <!-- No min/max so older years are allowed; if your phone’s date picker won't go far, type it in. -->
      <input type="date" id="dob" name="dob">

      <label for="age">Age (Auto-calc)</label>
      <input type="text" id="age" name="age" readonly placeholder="Will calculate from DOB">

      <label for="residentPhone">Resident’s Phone Number</label>
      <input type="text" id="residentPhone" name="residentPhone" placeholder="07123 456789">

      <label for="residentEmail">Resident’s Email</label>
      <input type="text" id="residentEmail" name="residentEmail" placeholder="example@domain.com">

      <label for="nhsNumber">NHS/CHI Number</label>
      <input type="text" id="nhsNumber" name="nhsNumber" placeholder="123-456-7890...">

      <label for="integrationId">Integration ID</label>
      <small>Can be auto-generated or manually entered. Signpost if needed.</small>
      <input type="text" id="integrationId" name="integrationId">

      <label><input type="checkbox" id="dnacpr" name="dnacpr"> DNACPR in Place?</label>
      <label><input type="checkbox" id="dols" name="dols"> Deprivation of Liberty Safeguards (DoLS) in Place?</label>
      <label><input type="checkbox" id="covid19" name="covid19"> Treating as COVID-19?</label>

      <div class="btn-container">
        <button type="button" class="btn-nav" id="nextBtn1">Next</button>
      </div>
    </div>

    <!-- ================= STEP 2: BIOGRAPHY & QUICK NOTES ================= -->
    <div class="form-step" id="step-2">
      <h2>Step 2: Biography & Quick Notes</h2>
      <label for="biography">Biography</label>
      <small>
        Provide a brief account of the resident’s life: past, present, interests, family, relationships, career, religious beliefs.  
        (Do not include medical information. Keep it factual—avoid assumptions.)
      </small>
      <textarea id="biography" name="biography" rows="4" placeholder="e.g., Born in..., loves knitting, reading..."></textarea>

      <label for="quickNotes">General Quick Notes</label>
      <small>Short immediate observations or personal preferences (non-medical if possible).</small>
      <textarea id="quickNotes" name="quickNotes" rows="3"></textarea>

      <div class="btn-container">
        <button type="button" class="btn-nav" id="prevBtn2">Previous</button>
        <button type="button" class="btn-nav" id="nextBtn2">Next</button>
      </div>
    </div>

    <!-- ================= STEP 3: CIRCLE OF CARE ================= -->
    <div class="form-step" id="step-3">
      <h2>Step 3: Circle of Care</h2>
      <label for="nokFullName">Next of Kin Full Name</label>
      <input type="text" id="nokFullName" name="nokFullName" placeholder="e.g., Jane Doe">

      <label for="nokRelationship">Relationship</label>
      <small>(e.g., Daughter, Son, Best Friend)</small>
      <input type="text" id="nokRelationship" name="nokRelationship" placeholder="Daughter">

      <label for="nokPhone">Phone Number</label>
      <input type="text" id="nokPhone" name="nokPhone" placeholder="07123 456789">

      <label><input type="checkbox" id="poaHealth" name="poaHealth"> Power of Attorney for Health?</label>
      <label><input type="checkbox" id="poaFinance" name="poaFinance"> Power of Attorney for Finance?</label>

      <div class="btn-container">
        <button type="button" class="btn-nav" id="prevBtn3">Previous</button>
        <button type="button" class="btn-nav" id="nextBtn3">Next</button>
      </div>
    </div>

    <!-- ================= STEP 4: ONBOARDING & NEEDS ASSESSMENT ================= -->
    <div class="form-step" id="step-4">
      <h2>Step 4: Onboarding & Needs Assessment</h2>
      <label for="dateAdmission">Date of Admission</label>
      <input type="date" id="dateAdmission" name="dateAdmission">

      <label for="admittedFrom">Admitted From</label>
      <small>(e.g., Hospital, Home, Another Care Facility)</small>
      <input type="text" id="admittedFrom" name="admittedFrom" placeholder="Local Hospital...">

      <label for="fundingSource">Funding Source</label>
      <small>(e.g., NHS, Private, Local Authority)</small>
      <input type="text" id="fundingSource" name="fundingSource" placeholder="NHS/Private...">

      <div class="btn-container">
        <button type="button" class="btn-nav" id="prevBtn4">Previous</button>
        <button type="button" class="btn-nav" id="nextBtn4">Next</button>
      </div>
    </div>

    <!-- ================= STEP 5: CLINICAL INFORMATION ================= -->
    <div class="form-step" id="step-5">
      <h2>Step 5: Clinical Information</h2>
      <label for="allergies">Allergies &amp; Intolerances</label>
      <small>Avoid “none” unless truly applicable. E.g., allergic to penicillin or peanuts.</small>
      <textarea id="allergies" name="allergies" rows="3"></textarea>

      <label for="dietaryPreferences">Dietary Preferences &amp; Nutrition Needs</label>
      <small>
        e.g. Vegetarian, Halal, Low-Salt.  
        If bed-bound, ensure upright at 90° while feeding, remain upright 30 mins after to aid digestion.
      </small>
      <textarea id="dietaryPreferences" name="dietaryPreferences" rows="3"></textarea>

      <label for="emergencyInfo">Emergency Information &amp; Admission Decision</label>
      <small>Who makes medical decisions in emergencies? How to notify next of kin first, etc.</small>
      <textarea id="emergencyInfo" name="emergencyInfo" rows="3"></textarea>

      <label for="clinicalHistory">Clinical History &amp; Medical Conditions</label>
      <small>List diagnoses (e.g., Diabetes, Epilepsy, Parkinson’s). Indicate any relevant care plans needed.</small>
      <textarea id="clinicalHistory" name="clinicalHistory" rows="3"></textarea>

      <label for="medicationList">Medication List</label>
      <small>
        Type of medication (e.g., for Parkinson’s), side effects, any special instructions (time-sensitive, crush pills, etc.).
      </small>
      <textarea id="medicationList" name="medicationList" rows="3"></textarea>

      <h3>Malnutrition Universal Screening Tool (MUST)</h3>
      <label for="currentWeight">Current Weight (kg)</label>
      <input type="number" id="currentWeight" name="currentWeight" step="0.1" placeholder="e.g. 70.5">

      <label for="currentHeight">Current Height (m)</label>
      <input type="number" id="currentHeight" name="currentHeight" step="0.01" placeholder="e.g. 1.75">

      <label for="bmiScore">BMI Score (Auto-calc)</label>
      <small>Auto-calculated as weight (kg) ÷ [height(m)²]</small>
      <input type="text" id="bmiScore" name="bmiScore" readonly placeholder="Auto-calc">

      <label for="weightLoss">Weight Loss in Past 3-6 Months (%)</label>
      <input type="number" id="weightLoss" name="weightLoss" step="0.1" placeholder="e.g. 5.0">

      <label for="mustScore">Overall MUST Score</label>
      <small>Evaluate risk: Low, Medium, High</small>
      <input type="text" id="mustScore" name="mustScore" placeholder="e.g., 1 (low risk)">

      <div class="btn-container">
        <button type="button" class="btn-nav" id="prevBtn5">Previous</button>
        <button type="button" class="btn-nav" id="nextBtn5">Next</button>
      </div>
    </div>

    <!-- ================= STEP 6: MANDATORY CARE PLAN SECTIONS ================= -->
    <div class="form-step" id="step-6">
      <h2>Step 6: Mandatory Care Plan Sections</h2>

      <label for="advancedPlanning">Advanced Planning / End of Life (EOL)</label>
      <small>
        DNACPR or ReSPECT forms? Funeral arrangements? POA/LPA in place?  
        Cultural or religious preferences for final days (music, visitors, etc.)?
      </small>
      <textarea id="advancedPlanning" name="advancedPlanning" rows="3"></textarea>

      <label for="cognition">Cognition</label>
      <small>Dementia, memory issues, how they prefer to communicate, strategies for memory support.</small>
      <textarea id="cognition" name="cognition" rows="3"></textarea>

      <label for="communication">Communication</label>
      <small>Hearing/speech impairments, communication aids, signposting if they use hearing aids or braille, etc.</small>
      <textarea id="communication" name="communication" rows="3"></textarea>

      <label for="continenceCare">Continence Care</label>
      <small>Type and size of continence products, assistance needed, routines. Avoid terms like “toileting.”</small>
      <textarea id="continenceCare" name="continenceCare" rows="3"></textarea>

      <label for="emotionalWellbeing">Emotional Well-being &amp; Mental Health</label>
      <small>Identify any mental health conditions, coping mechanisms, risk factors if untreated, support needed.</small>
      <textarea id="emotionalWellbeing" name="emotionalWellbeing" rows="3"></textarea>

      <label for="sexuality">Expressing Sexuality</label>
      <small>Clothing, makeup, jewellery, chosen name/pronoun, hairdresser visits, pampering, etc.</small>
      <textarea id="sexuality" name="sexuality" rows="3"></textarea>

      <label for="lifeEnrichment">Life Enrichment &amp; Social Activities</label>
      <small>Hobbies, interests, outings, social preferences (music, clubs, reading, etc.).</small>
      <textarea id="lifeEnrichment" name="lifeEnrichment" rows="3"></textarea>

      <label for="medicationManagement">Medication Management</label>
      <small>
        Summarise how staff/resident handle meds, if time-sensitive, side effects to watch for.  
        (e.g., “Staff to check side effects, see Camascope for details.”)
      </small>
      <textarea id="medicationManagement" name="medicationManagement" rows="3"></textarea>

      <label for="mobilityDexterity">Mobility &amp; Dexterity</label>
      <small>
        Note if resident is left-handed, can do buttons/zips, uses a walker, wheelchair, has a history of falls, signpost to handling plan.
      </small>
      <textarea id="mobilityDexterity" name="mobilityDexterity" rows="3"></textarea>

      <label for="nutritionHydration">Nutrition &amp; Hydration</label>
      <small>
        Food preferences, risk of choking, clothes protector usage, ensuring 90° upright if bed-bound.  
        e.g. “Resident uses adaptive cutlery, staff to encourage fluids hourly.”
      </small>
      <textarea id="nutritionHydration" name="nutritionHydration" rows="3"></textarea>

      <label for="oralHealth">Oral Health Care</label>
      <small>
        Dentures? Electric/manual toothbrush? Where dentures stored at night? Mouthwash, floss, tepe brushes, dentist visits.
      </small>
      <textarea id="oralHealth" name="oralHealth" rows="3"></textarea>

      <label for="personalCare">Personal Care &amp; Hygiene</label>
      <small>
        Washing, showering, hair removal, nail care, how many carers needed.  
        e.g. “Resident chooses clothes, staff assist with shampooing her hair weekly.”
      </small>
      <textarea id="personalCare" name="personalCare" rows="3"></textarea>

      <label for="physicalHealth">Physical Health &amp; Well-being</label>
      <small>Chronic conditions, therapies, any specialist input (e.g., physiotherapist). Signpost relevant plans.</small>
      <textarea id="physicalHealth" name="physicalHealth" rows="3"></textarea>

      <label for="skinIntegrity">Skin Integrity &amp; Pressure Care</label>
      <small>Wounds, dryness, risk of pressure sores, air mattress usage, involvement of DN/TVN, creams/emollients.</small>
      <textarea id="skinIntegrity" name="skinIntegrity" rows="3"></textarea>

      <label for="sleepingNightCare">Sleeping &amp; Night Care</label>
      <small>Night routine, removing dentures, lights on/off, call bell within reach, how often staff checks, bed positioning.</small>
      <textarea id="sleepingNightCare" name="sleepingNightCare" rows="3"></textarea>

      <div class="btn-container">
        <button type="button" class="btn-nav" id="prevBtn6">Previous</button>
        <button type="button" class="btn-nav" id="nextBtn6">Next</button>
      </div>
    </div>

    <!-- ================= STEP 7: SPECIALIST CARE PLANS (IF APPLICABLE) ================= -->
    <div class="form-step" id="step-7">
      <h2>Step 7: Specialist Care Plans (If Applicable)</h2>
      <label for="specialistCarePlans">Details</label>
      <small>
        List any condition requiring more detail:
        <ul>
          <li>Diabetes (blood sugar monitoring, insulin regimen, foot care)</li>
          <li>Epilepsy (seizure triggers, rescue meds)</li>
          <li>Parkinson’s (timing of medication, mobility changes)</li>
          <li>Heart Disease (angina, heart failure, blood pressure monitoring)</li>
          <li>Anti-Coagulant (Warfarin, INR checks, bleeding risks)</li>
          <li>COPD/Asthma (inhalers, breathing exercises)</li>
          <li>Cancer Care (chemotherapy, pain management)</li>
          <li>Behaviours that Challenge (aggression, self-harm triggers)</li>
          <li>Smoking, Alcohol/Drug Use, etc.</li>
        </ul>
      </small>
      <textarea
        id="specialistCarePlans"
        name="specialistCarePlans"
        rows="5"
        placeholder="e.g., Parkinson’s requiring time-sensitive meds, Epilepsy with known triggers..."
      ></textarea>

      <div class="btn-container">
        <button type="button" class="btn-nav" id="prevBtn7">Previous</button>
        <button type="button" class="btn-nav" id="nextBtn7">Next</button>
      </div>
    </div>

    <!-- ================= STEP 8: FOOT CARE ASSESSMENT ================= -->
    <div class="form-step" id="step-8">
      <h2>Step 8: Foot Care Assessment</h2>
      <label for="existingFootConditions">Existing Foot Conditions (Bunions, Ulcers, Corns)</label>
      <textarea id="existingFootConditions" name="existingFootConditions" rows="3"></textarea>

      <label for="toenailCutting">Toenail Cutting Needs</label>
      <small>Do they see a chiropodist every 6 weeks? Does staff assist with moisturizing? etc.</small>
      <textarea id="toenailCutting" name="toenailCutting" rows="3"></textarea>

      <label><input type="checkbox" id="diabetesFoot" name="diabetesFoot"> Diabetes-related Foot Concerns?</label>
      <label><input type="checkbox" id="orthopedicFootwear" name="orthopedicFootwear"> Orthopedic Footwear Required?</label>

      <label for="podiatryVisits">Podiatry Visits (Frequency &amp; Details)</label>
      <textarea id="podiatryVisits" name="podiatryVisits" rows="3"></textarea>

      <div class="btn-container">
        <button type="button" class="btn-nav" id="prevBtn8">Previous</button>
        <button type="button" class="btn-nav" id="nextBtn8">Next</button>
      </div>
    </div>

    <!-- ================= STEP 9: STAFF SIGN-OFF & SUMMARY ================= -->
    <div class="form-step" id="step-9">
      <h2>Step 9: Staff Sign-Off</h2>
      <label for="completedBy">Assessment Completed By</label>
      <input type="text" id="completedBy" name="completedBy" placeholder="Staff member name">

      <label for="dateCompletion">Date of Completion</label>
      <input type="date" id="dateCompletion" name="dateCompletion">

      <label for="homeManagerApproval">Home Manager Approval</label>
      <input type="text" id="homeManagerApproval" name="homeManagerApproval" placeholder="Manager name or signature">

      <div class="btn-container">
        <button type="button" class="btn-nav" id="prevBtn9">Previous</button>
        <button type="button" id="generateSummaryBtn" class="btn-nav">Generate Summary</button>
        <button type="button" id="downloadPdfBtn" class="btn-nav">Download PDF</button>
      </div>

      <label for="summary">Pre-Assessment Summary</label>
      <textarea id="summary" readonly></textarea>
    </div>
  </form>

  <!-- ========== jsPDF from CDN ========== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    /* ===================== STEP NAVIGATION ===================== */
    const steps = document.querySelectorAll('.form-step');
    let currentStep = 0;

    // Next/Prev button references
    const nextBtn1 = document.getElementById('nextBtn1');
    const nextBtn2 = document.getElementById('nextBtn2'); const prevBtn2 = document.getElementById('prevBtn2');
    const nextBtn3 = document.getElementById('nextBtn3'); const prevBtn3 = document.getElementById('prevBtn3');
    const nextBtn4 = document.getElementById('nextBtn4'); const prevBtn4 = document.getElementById('prevBtn4');
    const nextBtn5 = document.getElementById('nextBtn5'); const prevBtn5 = document.getElementById('prevBtn5');
    const nextBtn6 = document.getElementById('nextBtn6'); const prevBtn6 = document.getElementById('prevBtn6');
    const nextBtn7 = document.getElementById('nextBtn7'); const prevBtn7 = document.getElementById('prevBtn7');
    const nextBtn8 = document.getElementById('nextBtn8'); const prevBtn8 = document.getElementById('prevBtn8');
    const prevBtn9 = document.getElementById('prevBtn9');

    function showStep(index) {
      steps.forEach((step, i) => {
        step.classList.remove('active');
        if(i === index) step.classList.add('active');
      });
      currentStep = index;
    }

    // Step 1 -> 2
    if(nextBtn1) nextBtn1.addEventListener('click', () => showStep(1));
    // Step 2 -> 1 or 3
    if(nextBtn2) nextBtn2.addEventListener('click', () => showStep(2));
    if(prevBtn2) prevBtn2.addEventListener('click', () => showStep(0));
    // Step 3 -> 2 or 4
    if(nextBtn3) nextBtn3.addEventListener('click', () => showStep(3));
    if(prevBtn3) prevBtn3.addEventListener('click', () => showStep(1));
    // Step 4 -> 3 or 5
    if(nextBtn4) nextBtn4.addEventListener('click', () => showStep(4));
    if(prevBtn4) prevBtn4.addEventListener('click', () => showStep(2));
    // Step 5 -> 4 or 6
    if(nextBtn5) nextBtn5.addEventListener('click', () => showStep(5));
    if(prevBtn5) prevBtn5.addEventListener('click', () => showStep(3));
    // Step 6 -> 5 or 7
    if(nextBtn6) nextBtn6.addEventListener('click', () => showStep(6));
    if(prevBtn6) prevBtn6.addEventListener('click', () => showStep(4));
    // Step 7 -> 6 or 8
    if(nextBtn7) nextBtn7.addEventListener('click', () => showStep(7));
    if(prevBtn7) prevBtn7.addEventListener('click', () => showStep(5));
    // Step 8 -> 7 or 9
    if(nextBtn8) nextBtn8.addEventListener('click', () => showStep(8));
    if(prevBtn8) prevBtn8.addEventListener('click', () => showStep(6));
    // Step 9 -> 8
    if(prevBtn9) prevBtn9.addEventListener('click', () => showStep(7));

    // Show first step
    showStep(0);

    /* ===================== AUTO-CALCULATE AGE & BMI ===================== */
    const dobField = document.getElementById('dob');
    const ageField = document.getElementById('age');
    const weightField = document.getElementById('currentWeight');
    const heightField = document.getElementById('currentHeight');
    const bmiField = document.getElementById('bmiScore');

    // Auto Age from DOB
    dobField.addEventListener('change', () => {
      const dobValue = dobField.value;
      if (!dobValue) {
        ageField.value = '';
        return;
      }
      const dobDate = new Date(dobValue);
      if (isNaN(dobDate.getTime())) {
        ageField.value = '';
        return;
      }
      const diffMs = Date.now() - dobDate.getTime();
      const ageYears = Math.floor(diffMs / (365.25 * 24 * 60 * 60 * 1000));
      if(ageYears >= 0) {
        ageField.value = `${ageYears} years`;
      } else {
        ageField.value = '';
      }
    });

    // Auto BMI from Weight & Height
    function recalcBMI() {
      const w = parseFloat(weightField.value);
      const h = parseFloat(heightField.value);
      if (w > 0 && h > 0) {
        const bmi = w / (h * h);
        bmiField.value = bmi.toFixed(1);
      } else {
        bmiField.value = '';
      }
    }
    weightField.addEventListener('input', recalcBMI);
    heightField.addEventListener('input', recalcBMI);

    /* ===================== SUMMARY & PDF GENERATION ===================== */
    const generateSummaryBtn = document.getElementById('generateSummaryBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const summaryArea = document.getElementById('summary');
    const form = document.getElementById('assessmentForm');

    function getFormData() {
      const data = new FormData(form);
      // Checkboxes
      const dnacpr = document.getElementById('dnacpr').checked ? 'Yes' : 'No';
      const dols = document.getElementById('dols').checked ? 'Yes' : 'No';
      const covid19 = document.getElementById('covid19').checked ? 'Yes' : 'No';
      const poaHealth = document.getElementById('poaHealth').checked ? 'Yes' : 'No';
      const poaFinance = document.getElementById('poaFinance').checked ? 'Yes' : 'No';
      const diabetesFoot = document.getElementById('diabetesFoot').checked ? 'Yes' : 'No';
      const orthopedicFootwear = document.getElementById('orthopedicFootwear').checked ? 'Yes' : 'No';

      return {
        title: data.get('title') || '',
        firstName: data.get('firstName') || '',
        lastName: data.get('lastName') || '',
        preferredName: data.get('preferredName') || '',
        sexAtBirth: data.get('sexAtBirth') || '',
        genderIdentity: data.get('genderIdentity') || '',
        dob: data.get('dob') || '',
        age: data.get('age') || '',
        residentPhone: data.get('residentPhone') || '',
        residentEmail: data.get('residentEmail') || '',
        nhsNumber: data.get('nhsNumber') || '',
        integrationId: data.get('integrationId') || '',
        dnacpr, dols, covid19,

        biography: data.get('biography') || '',
        quickNotes: data.get('quickNotes') || '',

        nokFullName: data.get('nokFullName') || '',
        nokRelationship: data.get('nokRelationship') || '',
        nokPhone: data.get('nokPhone') || '',
        poaHealth,
        poaFinance,

        dateAdmission: data.get('dateAdmission') || '',
        admittedFrom: data.get('admittedFrom') || '',
        fundingSource: data.get('fundingSource') || '',

        allergies: data.get('allergies') || '',
        dietaryPreferences: data.get('dietaryPreferences') || '',
        emergencyInfo: data.get('emergencyInfo') || '',
        clinicalHistory: data.get('clinicalHistory') || '',
        medicationList: data.get('medicationList') || '',
        currentWeight: data.get('currentWeight') || '',
        currentHeight: data.get('currentHeight') || '',
        bmiScore: data.get('bmiScore') || '',
        weightLoss: data.get('weightLoss') || '',
        mustScore: data.get('mustScore') || '',

        advancedPlanning: data.get('advancedPlanning') || '',
        cognition: data.get('cognition') || '',
        communication: data.get('communication') || '',
        continenceCare: data.get('continenceCare') || '',
        emotionalWellbeing: data.get('emotionalWellbeing') || '',
        sexuality: data.get('sexuality') || '',
        lifeEnrichment: data.get('lifeEnrichment') || '',
        medicationManagement: data.get('medicationManagement') || '',
        mobilityDexterity: data.get('mobilityDexterity') || '',
        nutritionHydration: data.get('nutritionHydration') || '',
        oralHealth: data.get('oralHealth') || '',
        personalCare: data.get('personalCare') || '',
        physicalHealth: data.get('physicalHealth') || '',
        skinIntegrity: data.get('skinIntegrity') || '',
        sleepingNightCare: data.get('sleepingNightCare') || '',

        specialistCarePlans: data.get('specialistCarePlans') || '',
        existingFootConditions: data.get('existingFootConditions') || '',
        toenailCutting: data.get('toenailCutting') || '',
        diabetesFoot,
        orthopedicFootwear,
        podiatryVisits: data.get('podiatryVisits') || '',

        completedBy: data.get('completedBy') || '',
        dateCompletion: data.get('dateCompletion') || '',
        homeManagerApproval: data.get('homeManagerApproval') || ''
      };
    }

    function createSummaryText(d) {
      return `
*** General Information ***
Title: ${d.title}
First Name: ${d.firstName}
Last Name: ${d.lastName}
Preferred Name: ${d.preferredName}
Sex at Birth: ${d.sexAtBirth}
Gender Identity: ${d.genderIdentity}
Date of Birth: ${d.dob}
Age: ${d.age}
Resident’s Phone: ${d.residentPhone}
Resident’s Email: ${d.residentEmail}
NHS/CHI Number: ${d.nhsNumber}
Integration ID: ${d.integrationId}
DNACPR in Place: ${d.dnacpr}
DoLS in Place: ${d.dols}
Treating as COVID-19: ${d.covid19}

*** Biography & Quick Notes ***
Biography: ${d.biography}
Quick Notes: ${d.quickNotes}

*** Circle of Care ***
Next of Kin: ${d.nokFullName}
Relationship: ${d.nokRelationship}
Phone: ${d.nokPhone}
POA for Health: ${d.poaHealth}
POA for Finance: ${d.poaFinance}

*** Onboarding & Needs Assessment ***
Date of Admission: ${d.dateAdmission}
Admitted From: ${d.admittedFrom}
Funding Source: ${d.fundingSource}

*** Clinical Information ***
Allergies & Intolerances: ${d.allergies}
Dietary Preferences & Nutrition Needs: ${d.dietaryPreferences}
Emergency Info & Admission Decision: ${d.emergencyInfo}
Clinical History & Medical Conditions: ${d.clinicalHistory}
Medication List: ${d.medicationList}
MUST:
  Weight (kg): ${d.currentWeight}
  Height (m): ${d.currentHeight}
  BMI Score: ${d.bmiScore}
  Weight Loss in Past 3-6 Months (%): ${d.weightLoss}
  Overall MUST Score: ${d.mustScore}

*** Mandatory Care Plan Sections ***
Advanced Planning (EOL): ${d.advancedPlanning}
Cognition: ${d.cognition}
Communication: ${d.communication}
Continence Care: ${d.continenceCare}
Emotional Well-being & Mental Health: ${d.emotionalWellbeing}
Expressing Sexuality: ${d.sexuality}
Life Enrichment & Social Activities: ${d.lifeEnrichment}
Medication Management: ${d.medicationManagement}
Mobility & Dexterity: ${d.mobilityDexterity}
Nutrition & Hydration: ${d.nutritionHydration}
Oral Health Care: ${d.oralHealth}
Personal Care & Hygiene: ${d.personalCare}
Physical Health & Well-being: ${d.physicalHealth}
Skin Integrity & Pressure Care: ${d.skinIntegrity}
Sleeping & Night Care: ${d.sleepingNightCare}

*** Specialist Care Plans (If Applicable) ***
${d.specialistCarePlans}

*** Foot Care Assessment ***
Existing Foot Conditions: ${d.existingFootConditions}
Toenail Cutting Needs: ${d.toenailCutting}
Diabetes-related Foot Concerns: ${d.diabetesFoot}
Orthopedic Footwear Required: ${d.orthopedicFootwear}
Podiatry Visits: ${d.podiatryVisits}

*** Staff Sign-Off ***
Assessment Completed By: ${d.completedBy}
Date of Completion: ${d.dateCompletion}
Home Manager Approval: ${d.homeManagerApproval}
`;
    }

    // Generate Summary
    const summaryArea = document.getElementById('summary');
    if(generateSummaryBtn) {
      generateSummaryBtn.addEventListener('click', () => {
        const formData = getFormData();
        summaryArea.value = createSummaryText(formData);
      });
    }

    // Download PDF
    if(downloadPdfBtn) {
      downloadPdfBtn.addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        function drawHeader() {
          doc.setFillColor(92,158,173); // Teal
          doc.rect(0, 0, pageWidth, 40, 'F');
          doc.setFont('Helvetica', 'bold');
          doc.setFontSize(18);
          doc.setTextColor(255,255,255);
          doc.text('Care Plan Pre-Assessment', 20, 26);
          doc.setFont('Helvetica', 'normal');
          doc.setFontSize(12);
          doc.setTextColor(0,0,0);
        }

        const formData = getFormData();
        const lines = createSummaryText(formData).split('\n');

        drawHeader();
        let x = 20;
        let y = 60;
        const lineHeight = 14;

        lines.forEach(line => {
          if (y > pageHeight - 40) {
            doc.addPage();
            drawHeader();
            y = 60;
          }
          if (line.startsWith('*** ')) {
            // Bold heading lines
            doc.setFont('Helvetica', 'bold');
            doc.setFontSize(13);
            doc.text(line.replace('*** ','') , x, y);
            doc.setFont('Helvetica', 'normal');
            doc.setFontSize(12);
          } else {
            const splitted = doc.splitTextToSize(line, 550);
            splitted.forEach(str => {
              doc.text(str, x, y);
              y += lineHeight;
              if (y > pageHeight - 40) {
                doc.addPage();
                drawHeader();
                y = 60;
              }
            });
            y -= lineHeight;
          }
          y += lineHeight;
        });

        doc.save('Resident_PreAssessment.pdf');
      });
    }
  </script>
</body>
</html>
